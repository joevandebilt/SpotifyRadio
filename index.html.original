<!DOCTYPE html>
<html>
<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>

  <title>Joe's Playlist Quererer</title>
</head>
<body>
  <div class="container text-center">
    <h1>Queue A Song </h1>

    <div class="row">
      <div class="col-3"></div>
      <div class="col-6">
        <input type="text" class="form-control" id="trackLink" placeholder="Copy Link Here" value="https://open.spotify.com/track/6mYrhCAGWzTdF8QnKuchXM?si=8afe3772751a4024" />
        <button type="button" class="btn btn-primary" onclick="submitToQueue();">Queue</button>
      </div>
      <div class="col-3"></div>
    </div>
    <div class="row">
      <div class="col-3"></div>
      <div class="col-6">
        <div id="resultPane" style="display: none;">
            <img src="#" id="queuedImage" />
            <h4 id="queuedTrack"></h4>
            <p class="text-muted">by</p>
            <p id="queuedArtist"></p>
            <button class="btn btn-primary" onclick="location.reload()">Another One</button>
        </div>
      <div class="col-3"></div>
    </div>
  </div>

  <script>

    var auth_token = null;

    $(document).ready(function() {
      var client_id = "046f25af5f1444a881c64cec8ec3f716";
      var client_secret = "92b961a57ec64206943e52e1e4508018";

      basicToken = btoa(client_id + ':' + client_secret);

      $.ajax({
        url: 'https://accounts.spotify.com/api/authorize',
        method: "POST",
        beforeSend: function(request) {
          request.setRequestHeader('Authorization', 'Basic ' + basicToken);
        },
        data: {
          client_id: client_id,
          response_type: 'code',
          redirect_uri: '#',          
          scope: "user-read-private user-read-email user-modify-playback-state"
        },
        json: true,
        success: function(body, success, response) {
          if (success && response.status === 200) {
            auth_token = body.access_token;

            $.ajax({
              url: "https://api.spotify.com/v1/me",
              type: "GET",
              beforeSend: function(request) {
                request.setRequestHeader('Authorization', 'Bearer ' + auth_token);
                request.setRequestHeader('Content-Type', 'application/json');
              },
              success: function(response) { console.log(response); },
              error: function (xhr, ajaxOptions, thrownError) {
                SomethingWentWrong();
              }
            });
          }
        },
        error: function (xhr, ajaxOptions, thrownError) {
          SomethingWentWrong();
        }
      });
    });

    function submitToQueue() {
      var trackLink = $("#trackLink").val();
      if (trackLink !== undefined && trackLink !== null && trackLink !== "") {
        var urlParts = trackLink.split("/");
        var trackUri = urlParts[urlParts.length-1];
        if (trackUri !== "")
        {
          var trackId = trackUri.split("?")[0];
          verifyTrackId(trackId);
        }
        else 
        {
          SomethingWentWrong();
        }
      }
      else 
      {
        SomethingWentWrong();
      }
    }

    function resetPanel() {

    }

    function verifyTrackId(trackId) {
      $.ajax({
        url: "https://api.spotify.com/v1/tracks/"+trackId,
        method: "GET",
        beforeSend: function(request) {
          request.setRequestHeader('Authorization', 'Bearer ' + auth_token);
          request.setRequestHeader('Content-Type', 'application/json');
        },
        success: processTrackInfoResponse,
        error: function (xhr, ajaxOptions, thrownError) {
          SomethingWentWrong();
        }
      });
    }

    function processTrackInfoResponse(track) {
      console.log(track);
      if (track != null){
        $("#queuedTrack").html(track.name)

        var artists = track.artists.map(function(a) { return a.name}).join(", ");
        $("#queuedArtist").html(artists)

        var image = track.album.images[0].url;
        $("#queuedImage").attr("src", image);

        $("#resultPane").show();
      }

      submitToSpotifyQueue(track.uri);
    }

    function submitToSpotifyQueue(uri, deviceid) {
      console.log(uri);
      $.ajax({
        url: "https://api.spotify.com/v1/me/player/queue",
        type: "POST",
        beforeSend: function(request) {
          request.setRequestHeader('Authorization', 'Bearer ' + auth_token);
          request.setRequestHeader('Content-Type', 'application/json');
        },
        data: {
          "uri": uri
        },
        success: function(response) { console.log(response); },
        error: function (xhr, ajaxOptions, thrownError) {
          SomethingWentWrong();
        }
      });
    }

    function SomethingWentWrong() {
      alert("O no hed");
    }

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</body>